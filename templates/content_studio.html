{% extends "base.html" %}

{% block title %}Content Studio - News Insight Parser{% endblock %}

{% block content %}
<div class="content-studio">
    <h2>‚ú® Content Studio</h2>
    <p class="subtitle">–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –¥–ª—è —Å–æ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–µ—Ç–µ–π –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–∞—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö</p>

    <div class="studio-grid">
        <!-- Generator Panel -->
        <div class="generator-panel">
            <h3>–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç</h3>

            <div class="form-group">
                <label>–ò—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö:</label>
                <select id="source-type" class="form-control">
                    <option value="trend">üìà –¢—Ä–µ–Ω–¥–æ–≤–æ–µ –∫–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ</option>
                    <option value="topic">üè∑Ô∏è –¢–æ–ø–∏–∫ (–Ω–µ—Å–∫–æ–ª—å–∫–æ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤)</option>
                    <option value="cluster">üîó –ö–ª–∞—Å—Ç–µ—Ä –ø–æ—Ö–æ–∂–∏—Ö –ø–æ—Å—Ç–æ–≤</option>
                </select>
            </div>

            <!-- Trend Input -->
            <div id="trend-input" class="source-input">
                <div class="form-group">
                    <label>–í—ã–±–µ—Ä–∏—Ç–µ —Ç—Ä–µ–Ω–¥:</label>
                    <select id="trend-keyword" class="form-control">
                        {% for trend in trends[:10] %}
                        <option value="{{ trend.keyword }}">
                            {{ trend.keyword }} (+{{ trend.growth_rate }}% —Ä–æ—Å—Ç–∞, {{ trend.current_count }} —É–ø–æ–º–∏–Ω–∞–Ω–∏–π)
                        </option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <!-- Topic Input -->
            <div id="topic-input" class="source-input" style="display: none;">
                <div class="form-group">
                    <label>–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–ø–∏–∫:</label>
                    <select id="topic-keywords" class="form-control">
                        {% for topic in topics %}
                        <option value="{{ topic.keywords|join('|||') }}">
                            –¢–æ–ø–∏–∫ {{ topic.topic_id }}: {{ topic.keywords[:5]|join(', ') }} ({{ topic.post_count }} –ø–æ—Å—Ç–æ–≤)
                        </option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <!-- Cluster Input -->
            <div id="cluster-input" class="source-input" style="display: none;">
                <div class="form-group">
                    <label>–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∞—Å—Ç–µ—Ä:</label>
                    <select id="cluster-id" class="form-control">
                        {% for cluster in clusters %}
                        <option value="{{ cluster.cluster_id }}">
                            –ö–ª–∞—Å—Ç–µ—Ä {{ cluster.cluster_id }}: {{ cluster.top_keywords[:3]|join(', ') }} ({{ cluster.size }} –ø–æ—Å—Ç–æ–≤)
                        </option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label>–§–æ—Ä–º–∞—Ç –∫–æ–Ω—Ç–µ–Ω—Ç–∞:</label>
                <select id="format-type" class="form-control">
                    <option value="long_post">üìù Long Post (LinkedIn, Instagram carousel)</option>
                    <option value="reel">üì± Reel/Short (Instagram Reels, TikTok)</option>
                    <option value="thread">üßµ Thread (Twitter/X)</option>
                </select>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>–Ø–∑—ã–∫:</label>
                    <select id="language" class="form-control">
                        <option value="en">English</option>
                        <option value="ru">–†—É—Å—Å–∫–∏–π</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>–¢–æ–Ω:</label>
                    <select id="tone" class="form-control">
                        <option value="professional">Professional</option>
                        <option value="casual">Casual</option>
                        <option value="inspirational">Inspirational</option>
                    </select>
                </div>
            </div>

            <button id="generate-btn" class="btn btn-primary btn-large">
                üöÄ –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç
            </button>

            <div id="loading" style="display: none;" class="loading-indicator">
                <div class="spinner"></div>
                <p>ü§ñ –ì–µ–Ω–µ—Ä–∏—Ä—É—é –∫–æ–Ω—Ç–µ–Ω—Ç...</p>
                <p style="font-size: 14px; color: #666;">–≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å 30-90 —Å–µ–∫—É–Ω–¥. AI –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –ø–æ—Å—Ç—ã –∏ —Å–æ–∑–¥–∞–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç.</p>
                <p id="loading-timer" style="font-size: 12px; color: #999; margin-top: 10px;"></p>
            </div>
        </div>

        <!-- Preview Panel -->
        <div class="preview-panel">
            <h3>–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</h3>
            <div id="content-preview" class="content-preview">
                <p class="empty-state">–í—ã–±–µ—Ä–∏—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏ –Ω–∞–∂–º–∏—Ç–µ "–ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç"</p>
            </div>

            <div id="preview-actions" style="display: none;" class="preview-actions">
                <button id="copy-btn" class="btn btn-secondary">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
                <button id="mark-published-btn" class="btn btn-success">‚úÖ –û—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ</button>
            </div>
        </div>
    </div>

    <!-- Generated Content History -->
    <div class="generated-history">
        <h3>–ò—Å—Ç–æ—Ä–∏—è —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞</h3>
        <div class="content-grid">
            {% for content in generated %}
            <div class="content-card {{ 'published' if content.is_published else '' }}">
                <div class="content-header">
                    <span class="content-format">{{ content.format_type }}</span>
                    {% if content.is_published %}
                    <span class="badge badge-success">–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ</span>
                    {% endif %}
                </div>
                <h4>{{ content.title or '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è' }}</h4>
                <p class="content-snippet">{{ content.content[:150] }}...</p>
                <div class="content-meta">
                    <span>{{ content.word_count }} —Å–∏–º–≤–æ–ª–æ–≤</span>
                    <span>{{ content.created_at.strftime('%d.%m.%Y %H:%M') }}</span>
                </div>
                <div class="content-actions">
                    <button class="btn-small view-content" data-id="{{ content.id }}">–ü—Ä–æ—Å–º–æ—Ç—Ä</button>
                    <button class="btn-small delete-content" data-id="{{ content.id }}">–£–¥–∞–ª–∏—Ç—å</button>
                </div>
            </div>
            {% else %}
            <p class="empty-state">–ü–æ–∫–∞ –Ω–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞</p>
            {% endfor %}
        </div>
    </div>
</div>

<style>
.content-studio {
    padding: 20px 0;
}

.subtitle {
    color: #666;
    margin-bottom: 30px;
}

.studio-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 30px;
    margin-bottom: 40px;
}

.generator-panel, .preview-panel {
    background: white;
    padding: 25px;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    font-weight: 600;
    margin-bottom: 8px;
    color: #333;
}

.form-control {
    width: 100%;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 14px;
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
}

.btn-large {
    width: 100%;
    padding: 15px;
    font-size: 16px;
    font-weight: 600;
}

.loading-indicator {
    text-align: center;
    padding: 20px;
    color: #666;
}

.spinner {
    border: 3px solid #f3f3f3;
    border-top: 3px solid #007bff;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
    margin: 0 auto 15px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.content-preview {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 8px;
    min-height: 300px;
    white-space: pre-wrap;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

.empty-state {
    text-align: center;
    color: #999;
    padding: 40px 20px;
}

.preview-actions {
    display: flex;
    gap: 10px;
    margin-top: 15px;
}

.preview-actions button {
    flex: 1;
}

.generated-history {
    background: white;
    padding: 25px;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.content-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.content-card {
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    padding: 15px;
    transition: all 0.3s;
}

.content-card:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.content-card.published {
    border-color: #28a745;
}

.content-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}

.content-format {
    background: #007bff;
    color: white;
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 600;
}

.badge {
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
}

.badge-success {
    background: #28a745;
    color: white;
}

.content-card h4 {
    margin: 10px 0;
    font-size: 16px;
    color: #333;
}

.content-snippet {
    color: #666;
    font-size: 14px;
    line-height: 1.5;
    margin: 10px 0;
}

.content-meta {
    display: flex;
    gap: 15px;
    font-size: 12px;
    color: #999;
    margin: 10px 0;
}

.content-actions {
    display: flex;
    gap: 10px;
    margin-top: 15px;
}

.btn-small {
    padding: 6px 12px;
    font-size: 13px;
    border: 1px solid #ddd;
    background: white;
    border-radius: 4px;
    cursor: pointer;
}

.btn-small:hover {
    background: #f8f9fa;
}

@media (max-width: 768px) {
    .studio-grid {
        grid-template-columns: 1fr;
    }

    .form-row {
        grid-template-columns: 1fr;
    }

    .content-grid {
        grid-template-columns: 1fr;
    }
}
</style>

<script>
// Source type switcher
document.getElementById('source-type').addEventListener('change', function() {
    document.querySelectorAll('.source-input').forEach(el => el.style.display = 'none');
    const sourceType = this.value;
    document.getElementById(`${sourceType}-input`).style.display = 'block';
});

// Generate content
document.getElementById('generate-btn').addEventListener('click', async function() {
    const sourceType = document.getElementById('source-type').value;
    const formatType = document.getElementById('format-type').value;
    const language = document.getElementById('language').value;
    const tone = document.getElementById('tone').value;

    let requestData = {
        source_type: sourceType,
        format: formatType,
        language: language,
        tone: tone
    };

    // Get source-specific data
    if (sourceType === 'trend') {
        requestData.keyword = document.getElementById('trend-keyword').value;
        requestData.lookback_days = 7;
    } else if (sourceType === 'topic') {
        const topicSelect = document.getElementById('topic-keywords');
        const topicValue = topicSelect.value;

        if (!topicValue) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–ø–∏–∫ –∏–∑ —Å–ø–∏—Å–∫–∞.');
            return;
        }

        // Split by '|||' separator
        requestData.keywords = topicValue.split('|||').filter(k => k.trim());
        requestData.lookback_days = 7;

        console.log('Topic keywords:', requestData.keywords);
    } else if (sourceType === 'cluster') {
        requestData.cluster_id = document.getElementById('cluster-id').value;
    }

    console.log('Request data:', requestData);

    // Show loading
    document.getElementById('loading').style.display = 'block';
    document.getElementById('generate-btn').disabled = false;

    // Start timer
    let startTime = Date.now();
    const timerInterval = setInterval(() => {
        const elapsed = Math.floor((Date.now() - startTime) / 1000);
        document.getElementById('loading-timer').textContent = `–ü—Ä–æ—à–ª–æ: ${elapsed} —Å–µ–∫—É–Ω–¥...`;
    }, 1000);

    try {
        // Create AbortController for timeout
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 120000); // 120 seconds timeout

        const response = await fetch('/api/generate-content', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(requestData),
            signal: controller.signal
        });

        clearTimeout(timeoutId);

        // Check if response is ok
        if (!response.ok) {
            const errorData = await response.json().catch(() => ({ message: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' }));
            throw new Error(errorData.message || `HTTP ${response.status}`);
        }

        const result = await response.json();

        if (result.status === 'success') {
            displayGeneratedContent(result.content);
            // Reload page to show in history
            setTimeout(() => location.reload(), 2000);
        } else {
            alert('–û—à–∏–±–∫–∞: ' + result.message);
        }
    } catch (error) {
        if (error.name === 'AbortError') {
            alert('–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–Ω—è–ª–∞ —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ (>2 –º–∏–Ω—É—Ç). –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—ã–±—Ä–∞—Ç—å –º–µ–Ω—å—à–µ –ø–æ—Å—Ç–æ–≤ –∏–ª–∏ –¥—Ä—É–≥–æ–π —Ñ–æ—Ä–º–∞—Ç.');
        } else {
            alert('–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: ' + error.message);
        }
        console.error('Generation error:', error);
    } finally {
        clearInterval(timerInterval);
        document.getElementById('loading').style.display = 'none';
        document.getElementById('generate-btn').disabled = false;
    }
});

function displayGeneratedContent(content) {
    const preview = document.getElementById('content-preview');
    let html = '';

    if (content.title) {
        html += `<h3>${content.title}</h3><hr>`;
    }

    if (Array.isArray(content.content)) {
        // Thread format
        html += content.content.map((tweet, i) => `<p><strong>${i+1}.</strong> ${tweet}</p>`).join('');
    } else {
        html += `<p>${content.content}</p>`;
    }

    if (content.hashtags && content.hashtags.length > 0) {
        html += `<hr><p style="color: #007bff;">${content.hashtags.join(' ')}</p>`;
    }

    preview.innerHTML = html;
    document.getElementById('preview-actions').style.display = 'flex';

    // Store for copying
    window.generatedContent = content;
}

// Copy to clipboard
document.getElementById('copy-btn').addEventListener('click', function() {
    const content = window.generatedContent;
    if (!content) return;

    let text = '';
    if (content.title) text += content.title + '\n\n';

    if (Array.isArray(content.content)) {
        text += content.content.join('\n\n');
    } else {
        text += content.content;
    }

    if (content.hashtags && content.hashtags.length > 0) {
        text += '\n\n' + content.hashtags.join(' ');
    }

    navigator.clipboard.writeText(text).then(() => {
        alert('–ö–æ–Ω—Ç–µ–Ω—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!');
    });
});

// View content
document.querySelectorAll('.view-content').forEach(btn => {
    btn.addEventListener('click', async function() {
        const contentId = this.dataset.id;

        try {
            const response = await fetch(`/api/generated-content`);
            const allContent = await response.json();

            // Find the specific content by ID
            const content = allContent.find(c => c.id == contentId);

            if (content) {
                displayGeneratedContent(content);
                // Scroll to preview
                document.querySelector('.preview-panel').scrollIntoView({ behavior: 'smooth' });
            } else {
                alert('–ö–æ–Ω—Ç–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω');
            }
        } catch (error) {
            alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞: ' + error.message);
        }
    });
});

// Delete content
document.querySelectorAll('.delete-content').forEach(btn => {
    btn.addEventListener('click', async function() {
        if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –∫–æ–Ω—Ç–µ–Ω—Ç?')) return;

        const contentId = this.dataset.id;
        const response = await fetch(`/api/delete-content/${contentId}`, {
            method: 'DELETE'
        });

        if (response.ok) {
            location.reload();
        } else {
            alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
        }
    });
});
</script>
{% endblock %}
