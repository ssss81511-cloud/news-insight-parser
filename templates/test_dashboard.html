<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üß™ –¢–µ—Å—Ç-–î–∞—à–±–æ—Ä–¥ - News Insight Parser</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .content {
            padding: 30px;
        }

        .test-section {
            margin-bottom: 30px;
        }

        .test-section h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.5em;
        }

        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .test-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            border: 2px solid #e9ecef;
            transition: all 0.3s;
        }

        .test-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            border-color: #667eea;
        }

        .test-card h3 {
            color: #495057;
            margin-bottom: 10px;
            font-size: 1.2em;
        }

        .test-card p {
            color: #6c757d;
            margin-bottom: 15px;
            font-size: 0.95em;
        }

        .btn {
            display: inline-block;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: bold;
            text-decoration: none;
            cursor: pointer;
            border: none;
            font-size: 1em;
            transition: all 0.3s;
            width: 100%;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .progress-container {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            display: none;
        }

        .progress-container.active {
            display: block;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e9ecef;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .step-list {
            list-style: none;
        }

        .step-item {
            padding: 12px;
            margin-bottom: 8px;
            background: white;
            border-radius: 8px;
            border-left: 4px solid #e9ecef;
            display: flex;
            align-items: center;
            transition: all 0.3s;
        }

        .step-item.active {
            border-left-color: #ffc107;
            background: #fff3cd;
        }

        .step-item.completed {
            border-left-color: #28a745;
            background: #d4edda;
        }

        .step-item.error {
            border-left-color: #dc3545;
            background: #f8d7da;
        }

        .step-icon {
            width: 30px;
            height: 30px;
            margin-right: 12px;
            font-size: 1.5em;
        }

        .step-text {
            flex: 1;
        }

        .log-container {
            background: #212529;
            color: #00ff00;
            border-radius: 10px;
            padding: 20px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 20px;
            display: none;
        }

        .log-container.active {
            display: block;
        }

        .log-line {
            margin-bottom: 5px;
            line-height: 1.5;
        }

        .log-success {
            color: #28a745;
        }

        .log-error {
            color: #dc3545;
        }

        .log-warning {
            color: #ffc107;
        }

        .log-info {
            color: #17a2b8;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: bold;
            margin-left: 10px;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
        }

        .status-running {
            background: #fff3cd;
            color: #856404;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .spinner {
            display: inline-block;
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üß™ –¢–µ—Å—Ç-–î–∞—à–±–æ—Ä–¥</h1>
            <p>–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ—Ü–µ—Å—Å–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏</p>
        </div>

        <div class="content">
            <!-- –ë—ã—Å—Ç—Ä—ã–µ —Ç–µ—Å—Ç—ã -->
            <div class="test-section">
                <h2>üöÄ –ë—ã—Å—Ç—Ä—ã–µ —Ç–µ—Å—Ç—ã</h2>
                <div class="test-grid">
                    <div class="test-card">
                        <h3>1Ô∏è‚É£ –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–∞—Ä—Å–µ—Ä—ã</h3>
                        <p>–°–æ–±—Ä–∞—Ç—å –ø–æ—Å—Ç—ã –∏–∑ –≤—Å–µ—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ (2-3 –º–∏–Ω—É—Ç—ã)</p>
                        <button class="btn btn-primary" onclick="runParsers()">–ó–∞–ø—É—Å—Ç–∏—Ç—å</button>
                    </div>

                    <div class="test-card">
                        <h3>2Ô∏è‚É£ –ó–∞–ø—É—Å—Ç–∏—Ç—å –∞–Ω–∞–ª–∏—Ç–∏–∫—É</h3>
                        <p>–°–æ–∑–¥–∞—Ç—å —Ç–µ–º—ã –∏–∑ —Å–æ–±—Ä–∞–Ω–Ω—ã—Ö –ø–æ—Å—Ç–æ–≤ (30-60 —Å–µ–∫)</p>
                        <button class="btn btn-primary" onclick="runAnalytics()">–ó–∞–ø—É—Å—Ç–∏—Ç—å</button>
                    </div>

                    <div class="test-card">
                        <h3>3Ô∏è‚É£ –¢–µ—Å—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏</h3>
                        <p>–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç –∏ –æ–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å (10-15 —Å–µ–∫)</p>
                        <button class="btn btn-success" onclick="testAutoGenerate()">–¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                    </div>
                </div>
            </div>

            <!-- –ü–æ–ª–Ω—ã–π —Ç–µ—Å—Ç -->
            <div class="test-section">
                <h2>üéØ –ü–æ–ª–Ω—ã–π End-to-End —Ç–µ—Å—Ç</h2>
                <div class="test-card">
                    <h3>–ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏</h3>
                    <p>–ü–∞—Ä—Å–∏–Ω–≥ ‚Üí –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ ‚Üí –ì–µ–Ω–µ—Ä–∞—Ü–∏—è ‚Üí –ü—É–±–ª–∏–∫–∞—Ü–∏—è –≤ Telegram</p>
                    <button class="btn btn-warning" onclick="runFullTest()" id="fullTestBtn">
                        üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–æ–ª–Ω—ã–π —Ç–µ—Å—Ç (~4-5 –º–∏–Ω—É—Ç)
                    </button>
                </div>
            </div>

            <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å -->
            <div class="progress-container" id="progressContainer">
                <h3>–ü—Ä–æ–≥—Ä–µ—Å—Å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</h3>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%">0%</div>
                </div>

                <ul class="step-list" id="stepList">
                    <li class="step-item" id="step1">
                        <span class="step-icon">‚è≥</span>
                        <span class="step-text">–®–∞–≥ 1: –ó–∞–ø—É—Å–∫ –ø–∞—Ä—Å–µ—Ä–æ–≤...</span>
                    </li>
                    <li class="step-item" id="step2">
                        <span class="step-icon">‚è≥</span>
                        <span class="step-text">–®–∞–≥ 2: –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏ —Å–æ–∑–¥–∞–Ω–∏–µ —Ç–µ–º...</span>
                    </li>
                    <li class="step-item" id="step3">
                        <span class="step-icon">‚è≥</span>
                        <span class="step-text">–®–∞–≥ 3: –í—ã–±–æ—Ä —É–Ω–∏–∫–∞–ª—å–Ω–æ–π —Ç–µ–º—ã...</span>
                    </li>
                    <li class="step-item" id="step4">
                        <span class="step-icon">‚è≥</span>
                        <span class="step-text">–®–∞–≥ 4: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞ —á–µ—Ä–µ–∑ AI...</span>
                    </li>
                    <li class="step-item" id="step5">
                        <span class="step-icon">‚è≥</span>
                        <span class="step-text">–®–∞–≥ 5: –°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ä—Ç–∏–Ω–∫–∏ (reel)...</span>
                    </li>
                    <li class="step-item" id="step6">
                        <span class="step-icon">‚è≥</span>
                        <span class="step-text">–®–∞–≥ 6: –ü—É–±–ª–∏–∫–∞—Ü–∏—è –≤ Telegram...</span>
                    </li>
                </ul>
            </div>

            <!-- –õ–æ–≥–∏ -->
            <div class="log-container" id="logContainer"></div>

            <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
            <div class="test-section">
                <h2>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã</h2>
                <div class="stats-grid" id="statsGrid">
                    <div class="stat-card">
                        <div class="stat-value" id="statPosts">-</div>
                        <div class="stat-label">–ü–æ—Å—Ç–æ–≤ –≤ –ë–î</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="statTopics">-</div>
                        <div class="stat-label">–¢–µ–º —Å–æ–∑–¥–∞–Ω–æ</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="statGenerated">-</div>
                        <div class="stat-label">–ö–æ–Ω—Ç–µ–Ω—Ç–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="statPublished">-</div>
                        <div class="stat-label">–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ</div>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="loadStats()" style="margin-top: 20px;">
                    üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                </button>
            </div>
        </div>
    </div>

    <script>
        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        window.addEventListener('load', loadStats);

        function log(message, type = 'info') {
            const container = document.getElementById('logContainer');
            container.classList.add('active');
            const line = document.createElement('div');
            line.className = `log-line log-${type}`;
            const time = new Date().toLocaleTimeString();
            line.textContent = `[${time}] ${message}`;
            container.appendChild(line);
            container.scrollTop = container.scrollHeight;
        }

        function updateProgress(percent, step, status) {
            const fill = document.getElementById('progressFill');
            fill.style.width = percent + '%';
            fill.textContent = percent + '%';

            if (step) {
                const stepEl = document.getElementById('step' + step);
                stepEl.className = 'step-item ' + status;
                const icon = stepEl.querySelector('.step-icon');
                if (status === 'active') icon.textContent = '‚è≥';
                if (status === 'completed') icon.textContent = '‚úÖ';
                if (status === 'error') icon.textContent = '‚ùå';
            }
        }

        function showProgress() {
            document.getElementById('progressContainer').classList.add('active');
        }

        function hideProgress() {
            document.getElementById('progressContainer').classList.remove('active');
        }

        async function loadStats() {
            try {
                const response = await fetch('/api/auto-stats');
                const data = await response.json();

                if (data.status === 'success') {
                    document.getElementById('statGenerated').textContent = data.stats.total_generated || 0;
                    document.getElementById('statPublished').textContent = data.stats.total_published || 0;
                }

                // –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø–æ—Å—Ç–æ–≤ –∏ —Ç–µ–º
                const postsResp = await fetch('/api/posts/count');
                const postsData = await postsResp.json();
                document.getElementById('statPosts').textContent = postsData.count || 0;

                const topicsResp = await fetch('/api/topics');
                const topicsData = await topicsResp.json();
                document.getElementById('statTopics').textContent = topicsData.length || 0;

                log('–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞', 'success');
            } catch (error) {
                log('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: ' + error.message, 'error');
            }
        }

        async function runParsers() {
            log('–ó–∞–ø—É—Å–∫ –ø–∞—Ä—Å–µ—Ä–æ–≤...', 'info');
            showProgress();
            updateProgress(10, 1, 'active');

            try {
                const response = await fetch('/api/parse', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await response.json();

                updateProgress(100, 1, 'completed');
                log('–ü–∞—Ä—Å–µ—Ä—ã –∑–∞–≤–µ—Ä—à–µ–Ω—ã! –°–æ–±—Ä–∞–Ω–æ –ø–æ—Å—Ç–æ–≤: ' + (data.total_count || 0), 'success');
                await loadStats();
            } catch (error) {
                updateProgress(100, 1, 'error');
                log('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞: ' + error.message, 'error');
            }
        }

        async function runAnalytics() {
            log('–ó–∞–ø—É—Å–∫ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏...', 'info');
            showProgress();
            updateProgress(10, 2, 'active');

            try {
                const response = await fetch('/api/run-insights', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await response.json();

                updateProgress(100, 2, 'completed');
                log('–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –°–æ–∑–¥–∞–Ω–æ —Ç–µ–º: ' + (data.topics_found || 0), 'success');
                await loadStats();
            } catch (error) {
                updateProgress(100, 2, 'error');
                log('–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏: ' + error.message, 'error');
            }
        }

        async function testAutoGenerate() {
            log('–¢–µ—Å—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏...', 'info');
            showProgress();

            try {
                // Step 3: Topic Selection
                updateProgress(10, 3, 'active');
                log('[3/6] –í—ã–±–æ—Ä —É–Ω–∏–∫–∞–ª—å–Ω–æ–π —Ç–µ–º—ã...', 'info');
                await sleep(500);

                // Step 4: Content Generation
                updateProgress(25, 3, 'completed');
                updateProgress(25, 4, 'active');
                log('[4/6] –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞...', 'info');
                await sleep(500);

                // Step 5: Reel Generation
                updateProgress(50, 4, 'completed');
                updateProgress(50, 5, 'active');
                log('[5/6] –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–∞—Ä—Ç–∏–Ω–∫–∏...', 'info');

                // Actually call the API
                const response = await fetch('/api/auto-generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await response.json();

                if (data.status === 'success') {
                    // Step 6: Telegram Posting
                    updateProgress(75, 5, 'completed');
                    updateProgress(75, 6, 'active');
                    log('[6/6] –ü—É–±–ª–∏–∫–∞—Ü–∏—è –≤ Telegram...', 'info');
                    await sleep(500);

                    // Complete
                    updateProgress(100, 6, 'completed');
                    log(`‚úÖ –£–°–ü–ï–•! Content ID: ${data.content_id}`, 'success');
                    if (data.message_id) {
                        log(`üì® Telegram Message ID: ${data.message_id}`, 'success');
                    }
                    log(`üìù –¢–µ–º–∞: ${data.topic.keywords.slice(0, 3).join(', ')}`, 'info');
                    if (data.image_path) {
                        log(`üé® –ö–∞—Ä—Ç–∏–Ω–∫–∞: ${data.image_path}`, 'info');
                    }
                    log('üéâ –ü—Ä–æ–≤–µ—Ä—å Telegram –∫–∞–Ω–∞–ª: @newsinsigth', 'success');
                } else {
                    updateProgress(100, 3, 'error');
                    log('–û—à–∏–±–∫–∞: ' + data.error, 'error');
                }

                await loadStats();
            } catch (error) {
                updateProgress(100, 3, 'error');
                log('–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: ' + error.message, 'error');
            }
        }

        async function runFullTest() {
            const btn = document.getElementById('fullTestBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner">‚è≥</span> –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è...';

            log('========================================', 'info');
            log('–ü–û–õ–ù–´–ô –¢–ï–°–¢ –°–ò–°–¢–ï–ú–´ –ù–ê–ß–ê–¢', 'success');
            log('========================================', 'info');

            showProgress();

            // –®–∞–≥ 1: –ü–∞—Ä—Å–µ—Ä—ã
            updateProgress(0, 1, 'active');
            log('[1/6] –ó–∞–ø—É—Å–∫ –ø–∞—Ä—Å–µ—Ä–æ–≤...', 'info');
            await runParsers();
            await sleep(2000);

            // –®–∞–≥ 2: –ê–Ω–∞–ª–∏—Ç–∏–∫–∞
            updateProgress(33, 2, 'active');
            log('[2/6] –ó–∞–ø—É—Å–∫ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏...', 'info');
            await runAnalytics();
            await sleep(2000);

            // –®–∞–≥ 3-6: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏ –ø—É–±–ª–∏–∫–∞—Ü–∏—è
            updateProgress(66, 3, 'active');
            log('[3/6] –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏ –ø—É–±–ª–∏–∫–∞—Ü–∏—è...', 'info');
            await testAutoGenerate();

            updateProgress(100, 6, 'completed');
            log('========================================', 'info');
            log('‚úÖ –ü–û–õ–ù–´–ô –¢–ï–°–¢ –ó–ê–í–ï–†–®–ï–ù!', 'success');
            log('========================================', 'info');

            btn.disabled = false;
            btn.innerHTML = 'üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–æ–ª–Ω—ã–π —Ç–µ—Å—Ç (~4-5 –º–∏–Ω—É—Ç)';
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
    </script>
</body>
</html>
