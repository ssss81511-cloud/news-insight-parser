{% extends "base.html" %}

{% block title %}–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è - News Insight Parser{% endblock %}

{% block content %}
<div class="dashboard">
    <h2>–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</h2>

    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–∞–±–æ—Ç–µ –ø–∞—Ä—Å–µ—Ä–∞ -->
    <div class="card info-card">
        <h3>‚ÑπÔ∏è –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–∞—Ä—Å–µ—Ä</h3>
        <ul class="info-list">
            <li><strong>Ask HN:</strong> –°–æ–±–∏—Ä–∞–µ—Ç –≤–æ–ø—Ä–æ—Å—ã –∏ –ø—Ä–æ–±–ª–µ–º—ã –æ—Ç –æ—Å–Ω–æ–≤–∞—Ç–µ–ª–µ–π —Å—Ç–∞—Ä—Ç–∞–ø–æ–≤</li>
            <li><strong>Show HN:</strong> –ù–æ–≤—ã–µ –∑–∞–ø—É—Å–∫–∏ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –∏ –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ —Ñ–∏–¥–±—ç–∫</li>
            <li><strong>New:</strong> –°–∞–º—ã–µ —Å–≤–µ–∂–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ —Å Hacker News</li>
        </ul>
        <p class="small"><strong>–í—Ä–µ–º—è –ø–∞—Ä—Å–∏–Ω–≥–∞:</strong> ~2-3 –º–∏–Ω—É—Ç—ã (—Å–æ–±–∏—Ä–∞–µ—Ç ~60 –ø–æ—Å—Ç–æ–≤ + –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏)</p>
        <p class="small"><strong>–î–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è:</strong> <code>data/insights.db</code> (–ø–æ—Å—Ç–æ—è–Ω–Ω–æ –Ω–∞–∫–∞–ø–ª–∏–≤–∞—é—Ç—Å—è)</p>
    </div>

    <!-- Parser Controls -->
    <div class="card">
        <h3>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞—Ä—Å–µ—Ä–æ–º</h3>
        <div class="parser-control">
            <button id="start-parser" onclick="startParser()" class="btn btn-primary">
                –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–∞—Ä—Å–∏–Ω–≥
            </button>
            <div id="parser-status" class="status">
                {% if parser_status.is_running %}
                    <span class="status-running">–†–∞–±–æ—Ç–∞–µ—Ç: {{ parser_status.current_section }}</span>
                {% else %}
                    <span class="status-idle">–û–∂–∏–¥–∞–Ω–∏–µ</span>
                {% endif %}
            </div>
        </div>
        {% if parser_status.last_run %}
        <p class="small">–ü–æ—Å–ª–µ–¥–Ω–∏–π –∑–∞–ø—É—Å–∫: {{ time_ago(parser_status.last_run) }}</p>
        {% endif %}
    </div>

    <!-- Statistics -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-number">{{ stats.total_posts }}</div>
            <div class="stat-label">–í—Å–µ–≥–æ –ø–æ—Å—Ç–æ–≤</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ stats.ask_hn_count }}</div>
            <div class="stat-label">Ask HN</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ stats.show_hn_count }}</div>
            <div class="stat-label">Show HN</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ stats.new_count }}</div>
            <div class="stat-label">–ù–æ–≤—ã–µ</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ stats.total_comments }}</div>
            <div class="stat-label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ stats.total_signals }}</div>
            <div class="stat-label">–°–∏–≥–Ω–∞–ª—ã</div>
        </div>
    </div>

    <!-- Recent Parser Runs -->
    <div class="card">
        <h3>–ò—Å—Ç–æ—Ä–∏—è –∑–∞–ø—É—Å–∫–æ–≤ –ø–∞—Ä—Å–µ—Ä–∞</h3>
        {% if recent_runs %}
        <table>
            <thead>
                <tr>
                    <th>–ò—Å—Ç–æ—á–Ω–∏–∫</th>
                    <th>–†–∞–∑–¥–µ–ª</th>
                    <th>–°–æ–±—Ä–∞–Ω–æ</th>
                    <th>–°—Ç–∞—Ç—É—Å</th>
                    <th>–í—Ä–µ–º—è</th>
                </tr>
            </thead>
            <tbody>
                {% for run in recent_runs %}
                <tr>
                    <td>{{ run.source }}</td>
                    <td>{{ run.section }}</td>
                    <td>{{ run.items_fetched }}</td>
                    <td>
                        {% if run.status == 'success' %}
                            <span class="badge badge-{{ run.status }}">–£—Å–ø–µ—à–Ω–æ</span>
                        {% elif run.status == 'running' %}
                            <span class="badge badge-{{ run.status }}">–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è</span>
                        {% else %}
                            <span class="badge badge-{{ run.status }}">{{ run.status }}</span>
                        {% endif %}
                    </td>
                    <td>{{ time_ago(run.started_at) }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p class="empty-state">–ü–∞—Ä—Å–µ—Ä –µ—â—ë –Ω–µ –∑–∞–ø—É—Å–∫–∞–ª—Å—è. –ù–∞–∂–º–∏—Ç–µ "–ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–∞—Ä—Å–∏–Ω–≥" —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å.</p>
        {% endif %}
    </div>

    <!-- Quick Links -->
    <div class="quick-links">
        <a href="/posts?type=ask_hn" class="link-card">
            <h4>üìù Ask HN</h4>
            <p>–í–æ–ø—Ä–æ—Å—ã –∏ –æ–±—Å—É–∂–¥–µ–Ω–∏—è –æ—Ç –æ—Å–Ω–æ–≤–∞—Ç–µ–ª–µ–π</p>
        </a>
        <a href="/posts?type=show_hn" class="link-card">
            <h4>üöÄ Show HN</h4>
            <p>–ù–æ–≤—ã–µ –∑–∞–ø—É—Å–∫–∏ –∏ —Ä–∞–Ω–Ω–∏–µ —Ñ–∏–¥–±—ç–∫–∏</p>
        </a>
        <a href="/signals" class="link-card">
            <h4>üéØ –°–∏–≥–Ω–∞–ª—ã</h4>
            <p>–û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –∏ –∏–Ω—Å–∞–π—Ç—ã</p>
        </a>
    </div>
</div>

<script>
async function startParser() {
    const btn = document.getElementById('start-parser');
    btn.disabled = true;
    btn.textContent = '–ó–∞–ø—É—Å–∫–∞—é...';

    try {
        const response = await fetch('/api/parse', {
            method: 'POST'
        });
        const data = await response.json();

        if (response.ok) {
            alert('–ü–∞—Ä—Å–µ—Ä —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω! –ü—Ä–æ—Ü–µ—Å—Å –∑–∞–π–º—ë—Ç ~2-3 –º–∏–Ω—É—Ç—ã.');
            setTimeout(() => location.reload(), 2000);
        } else {
            alert('–û—à–∏–±–∫–∞: ' + data.message);
            btn.disabled = false;
            btn.textContent = '–ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–∞—Ä—Å–∏–Ω–≥';
        }
    } catch (error) {
        alert('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –ø–∞—Ä—Å–µ—Ä–∞: ' + error.message);
        btn.disabled = false;
        btn.textContent = '–ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–∞—Ä—Å–∏–Ω–≥';
    }
}
</script>
{% endblock %}
