{% extends "base.html" %}

{% block title %}–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è - News Insight Parser v2{% endblock %}

{% block content %}
<div class="dashboard">
    <h2>–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</h2>

    <!-- Parser Controls -->
    <div class="card">
        <h3>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞—Ä—Å–µ—Ä–æ–º</h3>
        <div class="parser-control">
            <button id="start-parser" onclick="startParser()" class="btn btn-primary">
                –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–∞—Ä—Å–∏–Ω–≥
            </button>
            <button id="analyze-signals" onclick="analyzeSignals()" class="btn" style="background: #9b59b6; color: white;">
                –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å–∏–≥–Ω–∞–ª—ã
            </button>
            <button id="cleanup-old" onclick="cleanupOldPosts()" class="btn" style="background: #e67e22; color: white;">
                –û—á–∏—Å—Ç–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –ø–æ—Å—Ç—ã
            </button>
            <button id="ai-analyze" onclick="aiAnalyzeBatch()" class="btn" style="background: #1abc9c; color: white;">
                ü§ñ AI –ê–Ω–∞–ª–∏–∑ –ø–æ—Å—Ç–æ–≤
            </button>
            <div id="parser-status" class="status">
                {% if parser_status.is_running %}
                    <span class="status-running">–†–∞–±–æ—Ç–∞–µ—Ç: {{ parser_status.current_section }}</span>
                {% else %}
                    <span class="status-idle">–û–∂–∏–¥–∞–Ω–∏–µ</span>
                {% endif %}
            </div>
        </div>
        {% if parser_status.last_run %}
        <p class="small">–ü–æ—Å–ª–µ–¥–Ω–∏–π –∑–∞–ø—É—Å–∫: {{ time_ago(parser_status.last_run) }}</p>
        {% endif %}
    </div>

    <!-- Scheduler Controls -->
    <div class="card">
        <h3>–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–∞—Ä—Å–∏–Ω–≥</h3>
        <div class="parser-control">
            <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 15px;">
                <button id="enable-scheduler" onclick="enableScheduler()" class="btn" style="background: #27ae60; color: white;">
                    –í–∫–ª—é—á–∏—Ç—å –≤—Å—ë
                </button>
                <button id="disable-scheduler" onclick="disableScheduler()" class="btn" style="background: #e74c3c; color: white;">
                    –û—Ç–∫–ª—é—á–∏—Ç—å –≤—Å—ë
                </button>
            </div>
            <div id="scheduler-status" class="status">
                <span class="status-idle">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
            </div>
        </div>

        <!-- Sources List -->
        <div id="sources-list" style="margin-top: 20px;">
            <h4 style="margin-bottom: 10px;">–ò—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–∞–Ω–Ω—ã—Ö:</h4>
            <div id="sources-container">
                <!-- Will be populated by JavaScript -->
            </div>
        </div>

        <!-- Active Jobs -->
        <div id="active-jobs" style="margin-top: 20px; display: none;">
            <h4 style="margin-bottom: 10px;">–ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–¥–∞—á–∏:</h4>
            <div id="jobs-container" style="font-size: 14px;">
                <!-- Will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Statistics -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-number">{{ stats.total_posts }}</div>
            <div class="stat-label">–í—Å–µ–≥–æ –ø–æ—Å—Ç–æ–≤</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ stats.ask_posts }}</div>
            <div class="stat-label">Ask HN</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ stats.show_posts }}</div>
            <div class="stat-label">Show HN</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ stats.new_posts }}</div>
            <div class="stat-label">–ù–æ–≤—ã–µ</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ stats.total_comments }}</div>
            <div class="stat-label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ stats.total_signals }}</div>
            <div class="stat-label">–°–∏–≥–Ω–∞–ª—ã</div>
        </div>
        <div class="stat-card" style="background: #fff3cd;">
            <div class="stat-number" style="color: #856404;">{{ stats.critical_signals }}</div>
            <div class="stat-label">üî¥ Critical</div>
        </div>
        <div class="stat-card" style="background: #cfe2ff;">
            <div class="stat-number" style="color: #084298;">{{ stats.trending_signals }}</div>
            <div class="stat-label">üî• Trending</div>
        </div>
    </div>

    <!-- Recent Parser Runs -->
    <div class="card">
        <h3>–ò—Å—Ç–æ—Ä–∏—è –∑–∞–ø—É—Å–∫–æ–≤ –ø–∞—Ä—Å–µ—Ä–∞</h3>
        {% if recent_runs %}
        <table>
            <thead>
                <tr>
                    <th>–ò—Å—Ç–æ—á–Ω–∏–∫</th>
                    <th>–†–∞–∑–¥–µ–ª</th>
                    <th>–°–æ–±—Ä–∞–Ω–æ</th>
                    <th>–°—Ç–∞—Ç—É—Å</th>
                    <th>–í—Ä–µ–º—è</th>
                </tr>
            </thead>
            <tbody>
                {% for run in recent_runs %}
                <tr>
                    <td>{{ run.source }}</td>
                    <td>{{ run.section }}</td>
                    <td>{{ run.items_fetched }}</td>
                    <td>
                        {% if run.status == 'success' %}
                            <span class="badge badge-{{ run.status }}">–£—Å–ø–µ—à–Ω–æ</span>
                        {% elif run.status == 'running' %}
                            <span class="badge badge-{{ run.status }}">–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è</span>
                        {% else %}
                            <span class="badge badge-{{ run.status }}">{{ run.status }}</span>
                        {% endif %}
                    </td>
                    <td>{{ time_ago(run.started_at) }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p class="empty-state">–ü–∞—Ä—Å–µ—Ä –µ—â—ë –Ω–µ –∑–∞–ø—É—Å–∫–∞–ª—Å—è. –ù–∞–∂–º–∏—Ç–µ "–ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–∞—Ä—Å–∏–Ω–≥" —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å.</p>
        {% endif %}
    </div>

    <!-- Quick Links -->
    <div class="quick-links">
        <a href="/posts?type=ask_hn" class="link-card">
            <h4>üìù Ask HN</h4>
            <p>–í–æ–ø—Ä–æ—Å—ã –∏ –æ–±—Å—É–∂–¥–µ–Ω–∏—è –æ—Ç –æ—Å–Ω–æ–≤–∞—Ç–µ–ª–µ–π</p>
        </a>
        <a href="/posts?type=show_hn" class="link-card">
            <h4>üöÄ Show HN</h4>
            <p>–ù–æ–≤—ã–µ –∑–∞–ø—É—Å–∫–∏ –∏ —Ä–∞–Ω–Ω–∏–µ —Ñ–∏–¥–±—ç–∫–∏</p>
        </a>
        <a href="/signals?priority=critical" class="link-card">
            <h4>üî¥ Critical Signals</h4>
            <p>–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã–µ —Å–∏–≥–Ω–∞–ª—ã</p>
        </a>
        <a href="/signals?trending=true" class="link-card">
            <h4>üî• Trending</h4>
            <p>–ì–æ—Ä—è—á–∏–µ —Ç—Ä–µ–Ω–¥—ã</p>
        </a>
    </div>
</div>

<script>
async function startParser() {
    const btn = document.getElementById('start-parser');
    btn.disabled = true;
    btn.textContent = '–ó–∞–ø—É—Å–∫–∞—é...';

    try {
        const response = await fetch('/api/parse', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({limit: 20})
        });
        const data = await response.json();

        if (response.ok) {
            alert('–ü–∞—Ä—Å–µ—Ä —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω! –ü—Ä–æ—Ü–µ—Å—Å –∑–∞–π–º—ë—Ç ~2-3 –º–∏–Ω—É—Ç—ã.');
            setTimeout(() => location.reload(), 2000);
        } else {
            alert('–û—à–∏–±–∫–∞: ' + data.message);
            btn.disabled = false;
            btn.textContent = '–ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–∞—Ä—Å–∏–Ω–≥';
        }
    } catch (error) {
        alert('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –ø–∞—Ä—Å–µ—Ä–∞: ' + error.message);
        btn.disabled = false;
        btn.textContent = '–ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–∞—Ä—Å–∏–Ω–≥';
    }
}

async function analyzeSignals() {
    const btn = document.getElementById('analyze-signals');
    btn.disabled = true;
    btn.textContent = '–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é...';

    try {
        const response = await fetch('/api/analyze-signals', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({lookback_days: 7, min_mentions: 3})
        });
        const data = await response.json();

        if (response.ok) {
            alert('–ê–Ω–∞–ª–∏–∑ —Å–∏–≥–Ω–∞–ª–æ–≤ –∑–∞–ø—É—â–µ–Ω! –ó–∞–π–º—ë—Ç ~30 —Å–µ–∫—É–Ω–¥.');
            setTimeout(() => location.reload(), 2000);
        } else {
            alert('–û—à–∏–±–∫–∞: ' + data.message);
        }
    } catch (error) {
        alert('–û—à–∏–±–∫–∞: ' + error.message);
    } finally {
        btn.disabled = false;
        btn.textContent = '–ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å–∏–≥–Ω–∞–ª—ã';
    }
}

async function cleanupOldPosts() {
    if (!confirm('–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –ø–æ—Å—Ç—ã —Å—Ç–∞—Ä—à–µ 2 –º–µ—Å—è—Ü–µ–≤?\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ!')) {
        return;
    }

    const btn = document.getElementById('cleanup-old');
    btn.disabled = true;
    btn.textContent = '–£–¥–∞–ª—è—é...';

    try {
        const response = await fetch('/api/cleanup-old-posts', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        });
        const data = await response.json();

        if (response.ok) {
            alert(`–£—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–æ ${data.deleted_count} –ø–æ—Å—Ç–æ–≤!`);
            setTimeout(() => location.reload(), 1000);
        } else {
            alert('–û—à–∏–±–∫–∞: ' + data.message);
        }
    } catch (error) {
        alert('–û—à–∏–±–∫–∞: ' + error.message);
    } finally {
        btn.disabled = false;
        btn.textContent = '–û—á–∏—Å—Ç–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –ø–æ—Å—Ç—ã';
    }
}

async function aiAnalyzeBatch() {
    const btn = document.getElementById('ai-analyze');
    btn.disabled = true;
    btn.textContent = '–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é...';

    try {
        const response = await fetch('/api/ai-analyze-batch', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({limit: 20})
        });
        const data = await response.json();

        if (response.ok) {
            alert(`${data.message}\n–≠—Ç–æ –∑–∞–π–º–µ—Ç ~2-3 –º–∏–Ω—É—Ç—ã.`);
            setTimeout(() => location.reload(), 2000);
        } else {
            alert('–û—à–∏–±–∫–∞: ' + data.message);
        }
    } catch (error) {
        alert('–û—à–∏–±–∫–∞: ' + error.message);
    } finally {
        btn.disabled = false;
        btn.textContent = 'ü§ñ AI –ê–Ω–∞–ª–∏–∑ –ø–æ—Å—Ç–æ–≤';
    }
}

async function enableScheduler() {
    const btn = document.getElementById('enable-scheduler');
    btn.disabled = true;
    btn.textContent = '–í–∫–ª—é—á–∞—é...';

    try {
        const response = await fetch('/api/scheduler/enable', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        });
        const data = await response.json();

        if (response.ok) {
            alert(data.message);
            updateSchedulerStatus();
        } else {
            alert('–û—à–∏–±–∫–∞: ' + data.message);
        }
    } catch (error) {
        alert('–û—à–∏–±–∫–∞: ' + error.message);
    } finally {
        btn.disabled = false;
        btn.textContent = '–í–∫–ª—é—á–∏—Ç—å –≤—Å—ë';
    }
}

async function disableScheduler() {
    const btn = document.getElementById('disable-scheduler');
    btn.disabled = true;
    btn.textContent = '–û—Ç–∫–ª—é—á–∞—é...';

    try {
        const response = await fetch('/api/scheduler/disable', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        });
        const data = await response.json();

        if (response.ok) {
            alert(data.message);
            updateSchedulerStatus();
        } else {
            alert('–û—à–∏–±–∫–∞: ' + data.message);
        }
    } catch (error) {
        alert('–û—à–∏–±–∫–∞: ' + error.message);
    } finally {
        btn.disabled = false;
        btn.textContent = '–û—Ç–∫–ª—é—á–∏—Ç—å –≤—Å—ë';
    }
}

async function toggleSource(sourceName, enabled) {
    const endpoint = enabled ? 'enable' : 'disable';

    try {
        const response = await fetch(`/api/scheduler/source/${sourceName}/${endpoint}`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        });
        const data = await response.json();

        if (response.ok) {
            updateSchedulerStatus();
        } else {
            alert('–û—à–∏–±–∫–∞: ' + data.message);
            // Revert checkbox
            updateSchedulerStatus();
        }
    } catch (error) {
        alert('–û—à–∏–±–∫–∞: ' + error.message);
        updateSchedulerStatus();
    }
}

async function updateSchedulerStatus() {
    try {
        const response = await fetch('/api/scheduler/status');
        const status = await response.json();

        // Update main status
        const statusDiv = document.getElementById('scheduler-status');
        if (status.auto_parse_enabled) {
            statusDiv.innerHTML = `<span class="status-running">–í–∫–ª—é—á–µ–Ω | –ó–∞–¥–∞—á: ${status.jobs.length}</span>`;
        } else {
            statusDiv.innerHTML = '<span class="status-idle">–û—Ç–∫–ª—é—á–µ–Ω</span>';
        }

        // Update sources list
        const sourcesContainer = document.getElementById('sources-container');
        if (status.sources && Object.keys(status.sources).length > 0) {
            let sourcesHTML = '';

            for (const [sourceName, sourceData] of Object.entries(status.sources)) {
                const enabled = sourceData.enabled;
                const schedule = sourceData.schedule;
                const lastParse = sourceData.last_parse;

                // Get source display name
                const displayName = schedule.name || sourceName;

                sourcesHTML += `
                    <div style="margin: 10px 0; padding: 10px; border: 1px solid #e0e0e0; border-radius: 4px;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox"
                                   ${enabled ? 'checked' : ''}
                                   onchange="toggleSource('${sourceName}', this.checked)"
                                   style="margin-right: 10px;">
                            <strong>${displayName}</strong>
                        </label>
                        <div style="margin-left: 30px; margin-top: 5px; font-size: 13px; color: #666;">
                `;

                // Show sections with intervals
                if (schedule.sections) {
                    for (const [sectionName, sectionConfig] of Object.entries(schedule.sections)) {
                        sourcesHTML += `
                            <div>‚Ä¢ ${sectionName}: –∫–∞–∂–¥—ã–µ ${sectionConfig.interval_hours} —á. (–¥–æ ${sectionConfig.limit} –ø–æ—Å—Ç–æ–≤)</div>
                        `;
                    }
                } else if (schedule.cron) {
                    sourcesHTML += `<div>‚Ä¢ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ: ${schedule.cron}</div>`;
                }

                if (lastParse) {
                    const lastParseDate = new Date(lastParse);
                    sourcesHTML += `<div style="margin-top: 5px; color: #999;">–ü–æ—Å–ª–µ–¥–Ω–∏–π –ø–∞—Ä—Å–∏–Ω–≥: ${lastParseDate.toLocaleString('ru-RU')}</div>`;
                }

                sourcesHTML += `
                        </div>
                    </div>
                `;
            }

            sourcesContainer.innerHTML = sourcesHTML;
        } else {
            sourcesContainer.innerHTML = '<p style="color: #999;">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤</p>';
        }

        // Update active jobs
        const jobsDiv = document.getElementById('active-jobs');
        const jobsContainer = document.getElementById('jobs-container');

        if (status.jobs && status.jobs.length > 0) {
            jobsDiv.style.display = 'block';
            let jobsHTML = '<div style="display: flex; flex-direction: column; gap: 8px;">';

            for (const job of status.jobs) {
                const nextRun = job.next_run ? new Date(job.next_run) : null;
                const timeUntil = nextRun ? getTimeUntil(nextRun) : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';

                jobsHTML += `
                    <div style="padding: 8px; background: #f5f5f5; border-radius: 4px;">
                        <strong>${job.name}</strong>
                        <div style="color: #666; font-size: 12px;">–°–ª–µ–¥—É—é—â–∏–π –∑–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ ${timeUntil}</div>
                    </div>
                `;
            }

            jobsHTML += '</div>';
            jobsContainer.innerHTML = jobsHTML;
        } else {
            jobsDiv.style.display = 'none';
        }
    } catch (error) {
        console.error('Failed to update scheduler status:', error);
    }
}

function getTimeUntil(targetDate) {
    const now = new Date();
    const diff = targetDate - now;

    if (diff < 0) return '—Å–∫–æ—Ä–æ';

    const hours = Math.floor(diff / (1000 * 60 * 60));
    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));

    if (hours > 0) {
        return `${hours}—á ${minutes}–º`;
    } else {
        return `${minutes}–º`;
    }
}

// Update scheduler status on page load
document.addEventListener('DOMContentLoaded', function() {
    updateSchedulerStatus();
    // Update status every 30 seconds
    setInterval(updateSchedulerStatus, 30000);
});
</script>
{% endblock %}
