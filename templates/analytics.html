{% extends "base.html" %}

{% block title %}–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ - News Insight Parser{% endblock %}

{% block content %}
<div class="analytics-page">
    <div class="page-header">
        <h2>üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏ –∏–Ω—Å–∞–π—Ç—ã</h2>

        <!-- Time range filter -->
        <div class="filter-section">
            <div class="filter-buttons">
                <a href="/analytics?days=3" class="btn {% if lookback_days == 3 %}btn-active{% endif %}">3 –¥–Ω—è</a>
                <a href="/analytics?days=7" class="btn {% if lookback_days == 7 %}btn-active{% endif %}">7 –¥–Ω–µ–π</a>
                <a href="/analytics?days=14" class="btn {% if lookback_days == 14 %}btn-active{% endif %}">14 –¥–Ω–µ–π</a>
                <a href="/analytics?days=30" class="btn {% if lookback_days == 30 %}btn-active{% endif %}">30 –¥–Ω–µ–π</a>
            </div>
        </div>
    </div>

    <!-- Top Stats -->
    <div class="stats-grid" style="margin-bottom: 30px;">
        <div class="stat-card">
            <h3>–¢–æ–ø –ø–æ—Å—Ç–æ–≤</h3>
            <p class="stat-number">{{ top_posts|length }}</p>
        </div>
        <div class="stat-card">
            <h3>–¢–æ–ø–∏–∫–æ–≤</h3>
            <p class="stat-number">{{ topics|length }}</p>
        </div>
        <div class="stat-card">
            <h3>–ö–ª–∞—Å—Ç–µ—Ä–æ–≤</h3>
            <p class="stat-number">{{ clusters|length }}</p>
        </div>
        <div class="stat-card">
            <h3>–¢—Ä–µ–Ω–¥–æ–≤</h3>
            <p class="stat-number">{{ trends.trending_keywords|length }}</p>
        </div>
    </div>

    <!-- Top Posts -->
    {% if top_posts %}
    <div class="card" style="margin-bottom: 30px;">
        <h3>üèÜ –¢–æ–ø –ø–æ—Å—Ç–æ–≤ –ø–æ –≤–∞–∂–Ω–æ—Å—Ç–∏</h3>
        <table class="trending-table">
            <thead>
                <tr>
                    <th style="width: 50%;">–ó–∞–≥–æ–ª–æ–≤–æ–∫</th>
                    <th>–ò—Å—Ç–æ—á–Ω–∏–∫</th>
                    <th>Score</th>
                    <th>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</th>
                    <th>–í–∞–∂–Ω–æ—Å—Ç—å</th>
                </tr>
            </thead>
            <tbody>
                {% for post in top_posts %}
                <tr>
                    <td>
                        {% if post.url %}
                        <a href="{{ post.url }}" target="_blank" style="color: #2c3e50; text-decoration: none;">
                            {{ post.title }}
                        </a>
                        {% else %}
                        {{ post.title }}
                        {% endif %}
                    </td>
                    <td>
                        <span class="badge" style="background: #3498db; color: white;">{{ post.source }}</span>
                    </td>
                    <td>{{ post.score }}</td>
                    <td>{{ post.comments_count }}</td>
                    <td>
                        <span class="badge" style="background: {% if post.importance_score > 70 %}#e74c3c{% elif post.importance_score > 50 %}#f39c12{% else %}#27ae60{% endif %}; color: white;">
                            {{ post.importance_score }}/100
                        </span>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    <!-- Charts Grid -->
    <div class="charts-grid">
        <!-- Timeline Chart -->
        <div class="chart-card">
            <h3>üìà –î–∏–Ω–∞–º–∏–∫–∞ –ø–æ—Å—Ç–æ–≤</h3>
            <canvas id="timelineChart"></canvas>
        </div>

        <!-- Source Distribution -->
        <div class="chart-card">
            <h3>üåê –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º</h3>
            <canvas id="sourceDistChart"></canvas>
        </div>
    </div>

    <!-- Trending Keywords -->
    {% if trends.trending_keywords %}
    <div class="card" style="margin-top: 30px;">
        <h3>üî• –†–∞—Å—Ç—É—â–∏–µ —Ç–µ–º—ã</h3>
        <table class="trending-table">
            <thead>
                <tr>
                    <th>–ö–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ</th>
                    <th>–°–µ–π—á–∞—Å</th>
                    <th>–†–∞–Ω–µ–µ</th>
                    <th>–†–æ—Å—Ç</th>
                </tr>
            </thead>
            <tbody>
                {% for item in trends.trending_keywords[:15] %}
                <tr>
                    <td><strong>{{ item.keyword }}</strong></td>
                    <td>{{ item.current_count }}</td>
                    <td>{{ item.previous_count }}</td>
                    <td>
                        <span class="growth-badge" style="background: {% if item.growth_rate > 100 %}#e74c3c{% elif item.growth_rate > 50 %}#f39c12{% else %}#27ae60{% endif %}; color: white; padding: 3px 8px; border-radius: 3px;">
                            +{{ item.growth_rate }}%
                        </span>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    <!-- Topics -->
    {% if topics %}
    <div class="section" style="margin-top: 30px;">
        <h3>üéØ –û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ —Ç–æ–ø–∏–∫–∏</h3>
        <div class="topics-grid">
            {% for topic in topics %}
            <div class="topic-card">
                <h4>–¢–æ–ø–∏–∫ #{{ topic.topic_id }}</h4>
                <div class="keywords">
                    {% for keyword in topic.keywords[:8] %}
                    <span class="keyword-tag">{{ keyword }}</span>
                    {% endfor %}
                </div>
                <p class="topic-meta">{{ topic.post_count }} –ø–æ—Å—Ç–æ–≤</p>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Clusters -->
    {% if clusters %}
    <div class="section" style="margin-top: 30px;">
        <h3>üß© –ö–ª–∞—Å—Ç–µ—Ä—ã —Å—Ö–æ–∂–∏—Ö –ø–æ—Å—Ç–æ–≤</h3>
        {% for cluster in clusters[:6] %}
        <div class="cluster-card card">
            <div class="cluster-header">
                <h4>–ö–ª–∞—Å—Ç–µ—Ä #{{ cluster.cluster_id }}</h4>
                <span class="badge" style="background: #3498db; color: white;">{{ cluster.size }} –ø–æ—Å—Ç–æ–≤</span>
                <span class="badge" style="background: #95a5a6; color: white;">avg: {{ cluster.avg_score }} points</span>
            </div>

            <div class="keywords" style="margin: 15px 0;">
                <strong>–ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞:</strong>
                {% for keyword in cluster.top_keywords[:10] %}
                <span class="keyword-tag">{{ keyword }}</span>
                {% endfor %}
            </div>

            <div class="sample-titles">
                <strong>–ü—Ä–∏–º–µ—Ä—ã:</strong>
                <ul>
                    {% for title in cluster.sample_titles %}
                    <li>{{ title }}</li>
                    {% endfor %}
                </ul>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
// Timeline Chart
const timelineData = {
    labels: {{ trends.timeline.dates|tojson }},
    datasets: [
        {
            label: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Å—Ç–æ–≤',
            data: {{ trends.timeline.post_counts|tojson }},
            borderColor: 'rgba(46, 204, 113, 1)',
            backgroundColor: 'rgba(46, 204, 113, 0.2)',
            tension: 0.3,
            yAxisID: 'y'
        },
        {
            label: '–°—Ä–µ–¥–Ω–∏–π score',
            data: {{ trends.timeline.avg_scores|tojson }},
            borderColor: 'rgba(241, 196, 15, 1)',
            backgroundColor: 'rgba(241, 196, 15, 0.2)',
            tension: 0.3,
            yAxisID: 'y1'
        }
    ]
};

new Chart(document.getElementById('timelineChart'), {
    type: 'line',
    data: timelineData,
    options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: {
            mode: 'index',
            intersect: false
        },
        scales: {
            y: {
                type: 'linear',
                display: true,
                position: 'left',
                title: { display: true, text: 'Posts' }
            },
            y1: {
                type: 'linear',
                display: true,
                position: 'right',
                title: { display: true, text: 'Score' },
                grid: { drawOnChartArea: false }
            }
        }
    }
});

// Source Distribution Pie Chart
const sourceDistData = {
    labels: {{ source_dist.sources|tojson }},
    datasets: [{
        data: {{ source_dist.counts|tojson }},
        backgroundColor: [
            'rgba(52, 152, 219, 0.8)',
            'rgba(46, 204, 113, 0.8)',
            'rgba(155, 89, 182, 0.8)',
            'rgba(241, 196, 15, 0.8)',
            'rgba(231, 76, 60, 0.8)',
            'rgba(26, 188, 156, 0.8)'
        ],
        borderWidth: 2,
        borderColor: '#fff'
    }]
};

new Chart(document.getElementById('sourceDistChart'), {
    type: 'doughnut',
    data: sourceDistData,
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom'
            }
        }
    }
});
</script>

<style>
.analytics-page {
    padding: 20px 0;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
}

.stat-card {
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    text-align: center;
}

.stat-card h3 {
    margin: 0 0 10px 0;
    font-size: 14px;
    color: #7f8c8d;
    text-transform: uppercase;
}

.stat-number {
    font-size: 32px;
    font-weight: bold;
    color: #2c3e50;
    margin: 0;
}

.charts-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 20px;
    margin-top: 30px;
}

.chart-card {
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    min-height: 300px;
}

.chart-card h3 {
    margin: 0 0 20px 0;
    color: #2c3e50;
}

.chart-card canvas {
    max-height: 350px;
}

.trending-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
}

.trending-table th,
.trending-table td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid #ecf0f1;
}

.trending-table th {
    background: #f8f9fa;
    font-weight: bold;
    color: #2c3e50;
}

.trending-table tr:hover {
    background: #f8f9fa;
}

.topics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 20px;
    margin-top: 15px;
}

.topic-card {
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.topic-card h4 {
    margin: 0 0 15px 0;
    color: #2c3e50;
}

.keywords {
    margin: 10px 0;
}

.keyword-tag {
    display: inline-block;
    background: #ecf0f1;
    color: #34495e;
    padding: 5px 10px;
    border-radius: 4px;
    font-size: 12px;
    margin: 3px;
}

.topic-meta {
    margin: 15px 0 0 0;
    color: #7f8c8d;
    font-size: 14px;
}

.cluster-card {
    margin-bottom: 20px;
}

.cluster-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 15px;
}

.cluster-header h4 {
    margin: 0;
    flex: 1;
    color: #2c3e50;
}

.sample-titles ul {
    margin: 10px 0 0 0;
    padding-left: 25px;
}

.sample-titles li {
    margin: 8px 0;
    color: #555;
}
</style>
{% endblock %}
