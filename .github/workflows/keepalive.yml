name: Wake and Run Parser

on:
  schedule:
    # Run 3 times daily at 8:55, 13:55, 19:55 UTC (5 min before parsing/posting)
    # This wakes up Render before scheduled tasks
    - cron: '55 8,13,19 * * *'
  workflow_dispatch: # Manual trigger

jobs:
  wake-server:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Wake server and trigger tasks
        run: |
          echo "üöÄ Waking server and triggering tasks at $(date -u)"
          echo "============================================"

          MAX_RETRIES=15
          RETRY_DELAY=45
          SUCCESS=false

          for i in $(seq 1 $MAX_RETRIES); do
            echo ""
            echo "Attempt $i/$MAX_RETRIES..."

            # Try to call wake-and-run endpoint (increased timeout for cold starts)
            RESPONSE=$(curl -s -w "\n%{http_code}" --max-time 120 \
              -X POST \
              https://news-insight-parser.onrender.com/api/wake-and-run)

            HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
            BODY=$(echo "$RESPONSE" | sed '$d')

            echo "HTTP Status: $HTTP_CODE"

            if [ "$HTTP_CODE" = "200" ]; then
              echo "‚úÖ Server responded successfully!"
              echo "Response: $BODY"

              # Parse and display triggered tasks
              TASKS=$(echo "$BODY" | grep -o '"tasks_triggered":\[[^]]*\]' || echo "[]")
              echo "Tasks triggered: $TASKS"

              SUCCESS=true
              break
            else
              echo "‚ö†Ô∏è Server returned: $HTTP_CODE"
              echo "Response: $BODY"

              if [ $i -lt $MAX_RETRIES ]; then
                echo "Waiting ${RETRY_DELAY}s before retry..."
                sleep $RETRY_DELAY
              fi
            fi
          done

          echo ""
          echo "============================================"

          if [ "$SUCCESS" = true ]; then
            echo "‚úÖ Wake-and-run completed successfully"
            exit 0
          else
            echo "‚ùå Failed to wake server after $MAX_RETRIES attempts"
            echo "Server may be down or experiencing issues"
            exit 1
          fi

      - name: Verify server is alive
        if: success()
        run: |
          echo ""
          echo "üîç Verifying server status..."

          STATUS=$(curl -s https://news-insight-parser.onrender.com/api/status | head -c 500)
          echo "Server status: $STATUS"

          echo "‚úÖ Server is alive and responding"

      - name: Completion summary
        if: always()
        run: |
          echo ""
          echo "============================================"
          echo "Wake-and-run workflow completed at $(date -u)"
          echo "Next run: Check GitHub Actions schedule"
          echo "============================================"
